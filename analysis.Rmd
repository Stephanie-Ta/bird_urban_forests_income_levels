# Analysis

## Global Variables

```{r}
# change this file path as necessary
DATA_FILE_PATH = "data/raw/Data sheets & inventory.xlsx"
GARDEN_FILE_PATH = "data/raw/GARDENS_spreadsheet.xlsx"
```

## Loading Libraries

```{r message=FALSE, warning=FALSE}
library(readxl)
library(janitor)
library(tidyverse)
library(broom)
library(lme4)
library(lmerTest)
library(plotly)
library(knitr)
```

## Reading in Data

```{r message = FALSE, warning = FALSE}
# get native percentage
garden_data <- read_excel(GARDEN_FILE_PATH, sheet='Native_vs_not_GRAPHING') |>
  select(House:Economic_level) |> # select necessary columns
  drop_na() |>  # remove empty rows
  clean_names()  # clean column names

native_percent <- garden_data |> # get native percentage per house
  select(house, native_percent_total)

# get main data
stats_data <- read_excel(DATA_FILE_PATH, sheet='Everything_statistics') |>
  select(House:Tree_percentage) |>  # select necessary columns
  drop_na() |>  # remove empty rows
  clean_names() |>  # clean column names
  mutate(dissemination_area = as.factor(str_sub(house, 1, 2))) |> # add dissemination area
  left_join(native_percent, by = join_by(house)) # add native percentage
```

```{r message = FALSE, warning = FALSE}
# get economic level data per dissemination area
economic_level_per_da <- read_excel(DATA_FILE_PATH, sheet='Overall Analysis') |>
  select(`Economic level (k)...21`:`DA...22`) |>
  drop_na() |>
  rename(economic_level_k = `Economic level (k)...21`,
         dissemination_area = `DA...22`)

# read in plant and shrub data
plant_shrub_data <- read_excel(GARDEN_FILE_PATH, sheet='Plantsnshrub_per_garden') |>
  clean_names() |>  # clean column names
  fill(house, .direction = "down")  # fill in missing house values

# isolate plant data
plant_data <- plant_shrub_data |>
  select(house, plants, native_or_not) |>
  drop_na() |>  # drop empty rows
  rename(name = plants, native_or_non_native = native_or_not) |>  # standardize column name
  mutate(type = "plant")  # add vegetation type

# isolate shrub data
shrub_data <- plant_shrub_data |>
  select(house, shrubs, native_or_non) |>
  drop_na() |>  # drop empty rows
  rename(native_or_non_native = native_or_non, name =  shrubs) |>  # standardize column name
  mutate(type = "shrub")  # add vegetation type

# put together plant and shrub data in a long format and clean it
plant_shrub_data_clean <- bind_rows(plant_data, shrub_data) |>
  mutate(native_or_non_native = case_when(native_or_non_native == "non" ~ "non-native",
                                          TRUE ~ native_or_non_native),  # standardize non vs. non-native
         dissemination_area = as.factor(str_sub(house, 1, 2)),  # add dissemination area
         name = str_to_sentence(name)) |>  # standardize capitalization of names
  left_join(economic_level_per_da, by=join_by(dissemination_area)) # add economic level

# read in tree data
tree_data <- read_excel(GARDEN_FILE_PATH, sheet='Tree_per_garden') |>
  clean_names() |>  # clean column names
  select(id:crown_area_m2) |>
  mutate(native_or_non_native = str_to_lower(native_or_non_native),
         type = "tree") |>
  rename(house = id, name = common_name) |>
  mutate(dissemination_area = as.factor(str_sub(house, 1, 2)),  # add dissemination area
         name = str_to_sentence(name),  # standardize capitalization of names
         type = "tree")

subset_tree_data <- tree_data |>
  select(house, name, native_or_non_native, dissemination_area, type) |>
  left_join(economic_level_per_da, by=join_by(dissemination_area)) # add economic level
```

## Exploratory Data Analysis

**Most Common Tree Species Per Economic Level / Dissemination Area**
```{r message = FALSE, warning = FALSE}
tree_counts_per_da <- subset_tree_data |>
  group_by(dissemination_area, economic_level_k, name, native_or_non_native, type) |>
  summarize(number = n()) |>
  ungroup() |>
  arrange(economic_level_k, desc(number)) |>
  mutate(da_el = str_c(dissemination_area, economic_level_k, sep = ", economic level: "),
         da_el = fct_reorder(da_el, economic_level_k))

tree_top_5_species_counts_per_da <- tree_counts_per_da |>
  group_by(economic_level_k, .drop = FALSE) |>
  slice(1:5) 
```

```{r, fig.width=7, fig.height=20}
ggplot(tree_top_5_species_counts_per_da,
       aes(x = number, y = fct_reorder(name, -number))) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  facet_wrap(~da_el, ncol = 1, scales = "free_y", axes = "all_x") +
  labs(title = "Top 5 Tree Species Per Dissemination Area/Economic Level",
       x = "Number Occurances",
       y = "Species") +
  theme_minimal()
```

**Most Common Plant and Shrub Species Per Economic Level / Dissemination Area**
```{r message = FALSE, warning = FALSE}
plant_shrub_counts_per_da <- plant_shrub_data_clean |>
  group_by(dissemination_area, economic_level_k, name, native_or_non_native, type) |>
  summarize(number = n()) |>
  ungroup() |>
  arrange(economic_level_k, desc(number)) |>
  mutate(da_el = str_c(dissemination_area, economic_level_k, sep = ", economic level: "),
         da_el = fct_reorder(da_el, economic_level_k))

plant_shrub_top_5_species_counts_per_da <- plant_shrub_counts_per_da |>
  group_by(economic_level_k, .drop = FALSE) |>
  slice(1:5) 
```

```{r, fig.width=7, fig.height=20}
ggplot(plant_shrub_top_5_species_counts_per_da,
       aes(x = number, y = fct_reorder(name, -number), fill = type)) +
  geom_bar(stat = "identity") +
  facet_wrap(~da_el, ncol = 1, scales = "free_y", axes = "all_x") +
  labs(title = "Top 5 Shrub/Plant Species Per Dissemination Area/Economic Level",
       x = "Number of Houses with the Species",
       y = "Shrub/Plant Species",
       fill = "Type") +
  theme_minimal()
```

## Chapter 1: How is Economic Level Associated with the Composition of Private Urban Forests?

In Chapter 1, we aimed to analyze the effect of economic level on the composition of private urban forests. Given this goal, we used multiple models with economic level as the explanatory variable. In this study, samples were taken per dissemination area. This means that our data points are **not** independent of each other. Instead, subsets of the data points share a correlation structure. To take this into account, we used linear **mixed effects** models so observations of the same dissemination area can share the same **random effect/intercept**, making a correlation structure. This is denoted by `(1 | dissemination_area)` in the model code.

Additionally, we are doing multiple tests to examine the effect of economic level on different elements of private urban forest composition. Without any correction, multiple tests run a higher risk of a type I error (rejecting a null hypothesis when it is true). To correct for this, we collected the p-values and applied a False Discovery Rate (FDR, aka Benjamini-Hochberg) correction, which keeps our expected proportion of type I errors under 0.05 in this study. We chose this less conservative approach over the Bonferroni correction (which controls for the probability of producing at least one type I error) since the consequences of a type I error from this study are not detrimental to human and environmental health.

### 1.1 Is vegetation diversity correlated with income/property value?

```{r}
ggplot(data = stats_data,
       aes(x = economic_level,
           y = overall_garden_diversity)) +
  geom_point() +
  labs(title = "Overall Garden Diversity vs. Economic Level",
       x = "Economic Level (k)",
       y = "Overall Garden Diversity") +
  theme_minimal()
```

```{r message=FALSE, warning=FALSE}
veg_div_model <- lmer(overall_garden_diversity ~ economic_level +
                  (1 | dissemination_area), data = stats_data)

summary(veg_div_model)

p_values <- tibble(question = 'veg diversity vs. economic level',
                  raw_p_value = summary(veg_div_model)$coefficients[2, "Pr(>|t|)"])
```

### 1.2 How does canopy cover vary across economic levels?

```{r}
ggplot(data = stats_data,
       aes(x = economic_level,
           y = canopy_cover_garden)) +
  geom_point() +
  labs(title = "Canopy Cover vs. Economic Level",
       x = "Economic Level (k)",
       y = "Canopy Cover") +
  theme_minimal()
```

```{r message=FALSE, warning=FALSE}
can_cover_model <- lmer(canopy_cover_garden ~ economic_level +
                    (1 | dissemination_area), data = stats_data)

summary(can_cover_model)

p_values <- rbind(
  p_values,
  tibble(
    question = 'canopy cover vs. economic level',
    raw_p_value = summary(can_cover_model)$coefficients[2, "Pr(>|t|)"]
  )
)
```

### 1.3 Are native species proportions influenced by economic level?

```{r}
ggplot(data = stats_data,
       aes(x = economic_level,
           y = native_percent_total)) +
  geom_point()  +
  labs(title = "Native Species Percentage vs. Economic Level",
       x = "Economic Level (k)",
       y = "Native Species (%)") +
  theme_minimal()
```

```{r message=FALSE, warning=FALSE}
native_species_model <- lmer(native_percent_total ~ economic_level +
                       (1 | dissemination_area), data = stats_data)

summary(native_species_model)

p_values <- rbind(
  p_values,
  tibble(
    question = 'native species percentage vs. economic level',
    raw_p_value = summary(native_species_model)$coefficients[2, "Pr(>|t|)"]
  )
)
```

### 1.4 Is Garden Size influenced by economic level?

```{r}
ggplot(data = stats_data,
       aes(x = economic_level,
           y = garden_size)) +
  geom_point()  +
  labs(title = "Garden Size vs. Economic Level",
       x = "Economic Level (k)",
       y = "Garden Size") +
  theme_minimal()
```

```{r message=FALSE, warning=FALSE}
garden_size_model <- lmer(garden_size ~ economic_level +
                       (1 | dissemination_area), data = stats_data)

summary(garden_size_model)

p_values <- rbind(
  p_values,
  tibble(
    question = 'garden size vs. economic level',
    raw_p_value = summary(garden_size_model)$coefficients[2, "Pr(>|t|)"]
  )
)
```

### Adjust p-values

Here, we adjusted the p-values of the coefficients of each private urban forest composition measure using the FDR correction.

We can see that economic level does not have a significant association with vegetation diversity (adjusted p-value = 0.9226) or native species percentage (adjusted p-value = 0.5931). However, it does have a significant association canopy cover (adjusted p-value = 0.0204) and garden size (adjusted p-value = 0.00999).

```{r, warning=FALSE}
p_values <- p_values |>
  mutate(adjusted_p_value = p.adjust(raw_p_value, method='fdr'))

kable(p_values)
```

## Chapter 2: Bird Species Richness

In this chapter, we aimed to investigate the following questions:

Is bird richness associated with vegetation diversity? Does canopy cover predict bird richness? Does % native vegetation influence native bird richness?

Again, we used a linear mixed effects model to take into account that observations were made per dissemination area and are not independent. Again, we used a FDR correction.

```{r, warning=FALSE, message=FALSE}
bird_richness <- lmer(bird_diversity ~ overall_garden_diversity +
                        canopy_cover_garden +
                        native_percent_total +
                        economic_level +
                        (1 | dissemination_area),
                      data = stats_data)

bird_richness_results <- summary(bird_richness)$coefficients |>
   as.data.frame() |>
  mutate(adjusted_p_value = p.adjust(`Pr(>|t|)`, 'fdr'))

kable(bird_richness_results)
```

From the table above, it does not appear that overall garden diversity, canopy cover, native plant percentage, or economic level have a significant association with bird species richness.
